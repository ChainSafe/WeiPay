fastlane_version '2.53.1'

before_all do
  setup_circle_ci
end

platform :ios do
  before_all do
    version_number = get_version_number(xcodeproj: "./ios/weipay.xcodeproj", target: "WeiPay")
    build_number = get_build_number(xcodeproj: "./ios/weipay.xcodeproj")
    ENV["VERSION_NUMBER"] = version_number + "." + build_number
  end

  desc 'Slack notification for succesful build to TestFlight'
  lane :slack_testflight do |values|
    slack(
      message: values[:msg],
      success: true,
      slack_url: "https://hooks.slack.com/services/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",
      attachment_properties: {
        fields: [
          {
             title: "Version number",
             value: ENV["VERSION_NUMBER"],
          },
        ]
      }
    )
  end

  desc 'Fetch certificates and provisioning profiles'
    lane :certificates do
      match(app_identifier: 'io.chainsafe.weipay', type: 'development', readonly: true)
      match(app_identifier: 'io.chainsafe.weipay', type: 'appstore', readonly: true)
    end

  desc 'Build the iOS application.'
    private_lane :build do
      certificates
      increment_build_number(xcodeproj: "./ios/weipay.xcodeproj")
      gym(scheme: 'WeiPay', project: './ios/weipay.xcodeproj')
    end

  desc 'Ship to Testflight.'
    lane :beta do
      build
      pilot(username: 'superadmin@chainsafe.io')
      slack_testflight(msg: "A new build has been uploaded to TestFlight!")
    end
end

platform :android do
  desc 'Slack notification for succesful build to Playstore'
  lane :slack_playstore do |values|
    slack(
      message: values[:msg],
      success: true,
      slack_url: "https://hooks.slack.com/services/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",
      attachment_properties: {
        fields: [
          {
             title: "Build number",
             value: ENV["BUILD_NUMBER"],
          },
        ]
      }
    )
  end

 desc 'Build the Android application.'
  private_lane :build do
    gradle(task: 'clean', project_dir: 'android/')
    gradle(task: 'assemble', build_type: 'Release', project_dir: 'android/')
  end

  desc 'Ship to Playstore Beta.'
  lane :beta do
    build
    supply(track: 'beta')
    slack_playstore(msg: "A new build has been uploaded to the PlayStore")
  end

  desc 'Promote Beta to Production.'
  lane :promote_prod do
    supply(track: 'beta', track_promote_to: 'production')
  end
end
